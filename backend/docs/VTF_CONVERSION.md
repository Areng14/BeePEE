# VTF Conversion Implementation

## Overview

This implementation adds automatic VTF (Valve Texture Format) conversion when users change item icons and save them. When an item's `editoritems.json` file references a palette image (like `"palette/beepkg/preplaced_gel.png"`), the system will:

1. Convert the staged icon to VTF format
2. Save the VTF to the correct materials directory 
3. Update the `editoritems.json` to reference the VTF path instead of the original image

## Architecture

### Files Added/Modified

- **`backend/utils/vtfConverter.js`** - New utility module for VTF conversion
- **`backend/saveItem.js`** - Modified to include VTF conversion in save process
- **`backend/__tests__/vtfConversion.test.js`** - Tests for VTF functionality
- **`backend/demo/vtfDemo.js`** - Demo script showing the conversion process

### Dependencies Added

- **`vtflib`** - VTF file creation and manipulation library
- **`sharp`** - Image processing library for preparing images for VTF conversion

## How It Works

### 1. Icon Save Process

When a user changes an icon and saves an item:

```javascript
// In saveItem.js
if (item.iconData && item.iconData.stagedIconPath) {
    // ... existing icon copying logic ...
    
    // NEW: VTF conversion
    await handleVTFConversion(editorItems, targetIconPath, packagePath, editorItemsPath)
}
```

### 2. VTF Conversion Logic

The `handleVTFConversion` function:

1. **Checks for palette images**: Looks for `"Image": "palette/..."` in editoritems.json
2. **Converts to VTF**: Uses `vtflib` to convert the staged icon to VTF format
3. **Updates references**: Modifies editoritems.json to point to the VTF file

### 3. Path Transformation

**Original path**: `"palette/beepkg/preplaced_gel.png"`

**VTF file location**: `[package]/resources/materials/models/props_map_editor/beepkg/preplaced_gel.vtf`

**Updated reference**: `"models/props_map_editor/beepkg/preplaced_gel"` (no extension)

## API Reference

### `convertImageToVTF(imagePath, outputPath, options)`

Converts an image file to VTF format.

**Parameters:**
- `imagePath` (string): Path to source image
- `outputPath` (string): Where to save the VTF file
- `options` (Object): Conversion options
  - `format` (string): VTF format (default: 'DXT5')
  - `generateMipmaps` (boolean): Generate mipmaps (default: true)

### `getVTFPathFromImagePath(packagePath, imagePath)`

Converts a palette image path to the corresponding VTF file path.

**Parameters:**
- `packagePath` (string): Package directory path
- `imagePath` (string): Original palette image path

**Returns:** Full path where VTF should be saved

### `updateEditorItemsWithVTF(editorItemsPath, originalImagePath, vtfPath, packagePath)`

Updates editoritems.json to reference the VTF instead of the original image.

**Parameters:**
- `editorItemsPath` (string): Path to editoritems.json
- `originalImagePath` (string): Original image path to replace
- `vtfPath` (string): Path to the VTF file
- `packagePath` (string): Package directory path

**Returns:** Updated editoritems object

## Example Usage

```javascript
const { convertImageToVTF, getVTFPathFromImagePath } = require('./utils/vtfConverter')

// Convert image to VTF
const vtfPath = getVTFPathFromImagePath('/path/to/package', 'palette/beepkg/icon.png')
await convertImageToVTF('/path/to/staged/icon.png', vtfPath, {
    format: 'DXT5',
    generateMipmaps: true
})
```

## Testing

Run VTF conversion tests:

```bash
npm test -- --testPathPatterns=vtfConversion
```

Run the demo:

```bash
node backend/demo/vtfDemo.js
```

## Error Handling

The VTF conversion process is designed to be non-blocking:

- If VTF conversion fails, the item save process continues
- Errors are logged but don't prevent the save operation
- The original PNG icon is still copied to maintain functionality

## Performance Considerations

- VTF conversion happens during the save process (user-initiated)
- Image processing may take a few seconds for large images
- Mipmaps are generated by default for better in-game performance
- DXT5 compression is used for good quality/size balance

## Future Enhancements

- **Batch conversion**: Convert multiple images at once
- **Format selection**: Allow users to choose VTF format
- **Compression options**: Expose more VTF compression settings
- **Progress indication**: Show conversion progress in UI